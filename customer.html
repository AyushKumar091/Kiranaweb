<!DOCTYPE html>
<html>

<>
    <title>My Orders - Kirana</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
            background: #f0f2f5;
            color: #333;
        }

        .container {
            max-width: 500px;
            margin: auto;
        }

        .order-box {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            margin-bottom: 30px;
        }

        #micBtn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            background: #28a745;
            color: white;
            font-size:
                25px;
            cursor: pointer;
        }

        #micBtn.recording {
            background: #dc3545;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        /* NEW: Item list with delete buttons */
        .current-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }

        .remove-btn {
            background: #ff4d4d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* History Section */
        .history-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            border-left: 6px solid #ccc;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            text-align: left;
        }

        .status-badge {
            float: right;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 20px;
            color: white;
            font-weight:
                bold;
            text-transform: uppercase;
        }

        .bg-PENDING {
            background: #6c757d;
        }

        .bg-ACCEPTED {
            background: #007bff;
        }

        .bg-READY {
            background: #28a745;
        }

        .send-btn {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            display: none;
        }
    </style>
    </head>

    <body>
        <div class="container">
            <div class="order-box">
                <h3>ðŸŽ¤ Record New Order</h3>
                <button id="micBtn">ðŸŽ¤</button>
                <div id="currentItems"><span style="color:#aaa">Speak items to build list...</span></div>
                <button id="sendBtn" class="send-btn">PLACE ORDER NOW</button>
            </div>

            <div class="history-header">
                <h3 style="margin:0;">ðŸ“œ Your Orders</h3>
                <button onclick="localStorage.clear(); location.reload();"
                    style="font-size:10px; background:none; border:none; color:red; cursor:pointer;">Clear All</button>
            </div>
            <div id="historyList">
                <p style="text-align:center; color:#999;">No previous orders yet.</p>
            </div>
        </div>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
            import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

            // YOUR FIREBASE CONFIG
            const firebaseConfig = {
                apiKey: "AIzaSyBXNNub5WpC4iNLyltbCfOztlMFsqMQqUY",
                authDomain: "kirana-4f9a2.firebaseapp.com",
                databaseURL: "https://kirana-4f9a2-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "kirana-4f9a2",
                storageBucket: "kirana-4f9a2.firebasestorage.app",
                appId: "1:786377704874:web:efbafb4b8a08e0cf0c57d3"
            };

            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);

            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'hi-IN';

            let currentSessionItems = [];
            const micBtn = document.getElementById('micBtn');
            const currentItemsDiv = document.getElementById('currentItems');
            const sendBtn = document.getElementById('sendBtn');
            const historyList = document.getElementById('historyList');

            // --- 1. MICROPHONE LOGIC ---
            micBtn.onclick = () => { try { recognition.start(); micBtn.classList.add('recording'); } catch (e) { recognition.stop(); } };

            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript.trim();
                if (text) {
                    const itemId = Date.now(); // Unique ID for delete function
                    addItemToCurrentList(itemId, text);
                }
            };
            recognition.onend = () => micBtn.classList.remove('recording');

            // --- 2. ADD & REMOVE ITEMS ---
            function addItemToCurrentList(id, text) {
                if (currentSessionItems.length === 0) currentItemsDiv.innerHTML = "";
                currentSessionItems.push({ id: id, name: text });

                const itemDiv = document.createElement('div');
                itemDiv.className = 'current-item';
                itemDiv.id = `item-${id}`;
                itemDiv.innerHTML = `<span>â€¢ ${text}</span><button class="remove-btn" onclick="window.removeItem(${id})">âœ•</button>`;
                currentItemsDiv.appendChild(itemDiv);
                sendBtn.style.display = "block";
            }

            window.removeItem = (id) => {
                currentSessionItems = currentSessionItems.filter(item => item.id !== id);
                document.getElementById(`item-${id}`).remove();
                if (currentSessionItems.length === 0) {
                    currentItemsDiv.innerHTML = '<span style="color:#aaa">List empty. Record items...</span>';
                    sendBtn.style.display = "none";
                }
            };

            // --- 3. SEND ORDER ---
            sendBtn.onclick = () => {
                const finalString = currentSessionItems.map(item => item.name).join('|');
                const newOrderRef = push(ref(db, 'orders'), { itemList: finalString, status: 'PENDING', timestamp: Date.now() });

                let myHistory = JSON.parse(localStorage.getItem('myOrders') || "[]");
                myHistory.push(newOrderRef.key);
                localStorage.setItem('myOrders', JSON.stringify(myHistory));

                currentSessionItems = [];
                currentItemsDiv.innerHTML = '<span style="color:#28a745">âœ… Order placed!</span>';
                sendBtn.style.display = "none";
                loadHistory();
            };

            // --- 4. LOAD HISTORY ---
            function loadHistory() {
                const myHistory = JSON.parse(localStorage.getItem('myOrders') || "[]");
                if (myHistory.length === 0) return;
                historyList.innerHTML = "";
                myHistory.forEach(id => {
                    onValue(ref(db, `orders/${id}`), (snapshot) => {
                        const data = snapshot.val();
                        if (!data) return;
                        let card = document.getElementById(`card-${id}`);
                        if (!card) {
                            card = document.createElement('div');
                            card.id = `card-${id}`;
                            historyList.prepend(card);
                        }
                        const itemsHtml = data.itemList.split('|').map(i => `<div>- ${i}</div>`).join('');
                        card.className = `history-card status-${data.status}`;
                        card.innerHTML = `<span class="status-badge bg-${data.status}">${data.status}</span><strong>#${id.slice(-4)}</strong><div style="font-size:14px; color:#555;">${itemsHtml}</div>`;
                    });
                });
            }
            window.onload = loadHistory;
        </script>
    </body>

</html>